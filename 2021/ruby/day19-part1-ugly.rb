require 'scanf'

data = File.read('../in/day19.in')

scanners = data.split("\n\n").map do |blk|
  blk.lines[1..].map { _1.scanf('%d,%d,%d') }
end

def overlap(sa, sb)
  orgs = [0, 1, 2].permutation
  dirs = [
    [1, 1, 1],
    [1, 1, -1],
    [1, -1, 1],
    [-1, 1, 1],
    [1, -1, -1],
    [-1, 1, -1],
    [-1, -1, 1],
    [-1, -1, -1]
  ]

  orgs.each do |oa, ob, oc|
    dirs.each do |ma, mb, mc|
      # sc = sb transformed by org and dir
      sc = sb.map { |p| [p[oa]*ma, p[ob]*mb, p[oc]*mc] }

      sa.each do |ax, ay, az|
        a = sa.map { |x, y, z| [x-ax, y-ay, z-az] }
        sc.each do |cx, cy, cz|
          c = sc.map { |x, y, z| [x-cx, y-cy, z-cz] }
          if (a & c).size >= 12
            return c.map { |x, y, z| [x+ax, y+ay, z+az] }
          end
        end
      end
    end
  end

  nil
end

done = [scanners.shift]

# # 1
# done << [[798, 1562, -610], [628, 429, 346], [-461, 1654, -762], [688, 1456, 553], [-401, 1668, 817], [-418, 610, -699], [-464, 1766, 685], [729, 1476, -697], [544, 505, 321], [698, 394, -619], [675, 1583, 633], [757, 1666, -710], [95, 1165, 18], [-405, 725, 448], [-512, 1705, 703], [-363, 523, -711], [-431, 1621, -701], [666, 506, 480], [806, 301, -633], [-299, 531, -672], [-439, 1644, -920], [-481, 563, 432], [-557, 720, 459], [9, 1106, -140], [682, 294, -783], [551, 1491, 610]]
# scanners.delete_at(1)
#
# # 23
# done << [[682, 294, -783], [1780, -538, -886], [628, 429, 346], [523, -841, -961], [657, -639, 635], [1914, 510, -748], [1862, 680, 290], [806, 301, -633], [599, -948, -962], [534, -850, -930], [637, -604, 531], [699, -593, 593], [698, 394, -619], [1238, -119, 17], [2004, 729, 253], [1768, -747, -909], [2107, -797, 430], [666, 506, 480], [1251, 41, -156], [1867, 405, -811], [2008, -827, 313], [1940, 285, -756], [1830, 727, 285], [1805, -695, -895], [1967, -735, 392], [544, 505, 321]]
# scanners.delete_at(23)
#
# # 18
# done << [[688, 1456, 553], [-481, 563, 432], [544, 505, 321], [-518, 1978, 1659], [-538, 507, 1536], [-427, 1870, 1609], [-512, 1705, 703], [-659, 464, 1450], [601, 644, 1804], [-610, 414, 1616], [628, 429, 346], [570, 1710, 1545], [666, 506, 480], [551, 1491, 610], [675, 1583, 633], [-514, 1914, 1760], [573, 1790, 1473], [-557, 720, 459], [17, 1232, 1072], [490, 690, 1848], [-464, 1766, 685], [494, 729, 1899], [-21, 1079, 1204], [641, 1862, 1474], [-405, 725, 448], [-401, 1668, 817]]
# scanners.delete_at(18)
#
# # 6
# done << [[2470, -69, -28], [2004, 729, 253], [1914, 510, -748], [1768, -747, -909], [1967, -735, 392], [2851, -533, 647], [2806, 768, 501], [2008, -827, 313], [2981, -813, -598], [1940, 285, -756], [1830, 727, 285], [3125, -745, -564], [1780, -538, -886], [3219, 690, -675], [3101, 751, -678], [2795, -506, 484], [2751, 804, 535], [1805, -695, -895], [2785, -481, 570], [2740, 631, 437], [2107, -797, 430], [3004, 719, -622], [1862, 680, 290], [1867, 405, -811], [3034, -909, -587]]
# scanners.delete_at(6)
#
# # 15
# done << [[1867, 405, -811], [1630, 512, -2054], [1914, 510, -748], [695, -764, -1619], [567, 530, -1665], [682, 294, -783], [1251, 29, -1348], [1805, -695, -895], [1780, -538, -886], [684, -941, -1645], [1832, -589, -1953], [1940, 285, -756], [570, 436, -1792], [599, -948, -962], [1656, 385, -2073], [1122, -16, -1168], [1798, 466, -2134], [1768, -747, -909], [546, 478, -1681], [584, -817, -1718], [698, 394, -619], [806, 301, -633], [1969, -618, -1964], [1902, -590, -1849], [534, -850, -930], [523, -841, -961]]
# scanners.delete_at(15)
#
# # 4
# done << [[-538, 507, 1536], [-1507, 752, 612], [-1674, 791, 555], [-1890, 371, 2016], [-405, 725, 448], [-2013, 1654, 643], [-659, 464, 1450], [-1979, 1736, 686], [-1711, 2029, 1546], [-1831, 474, 1956], [-1642, 1850, 1502], [-1194, 1106, 1119], [-427, 1870, 1609], [-1586, 600, 574], [-464, 1766, 685], [-401, 1668, 817], [-1737, 309, 1935], [-557, 720, 459], [-514, 1914, 1760], [-481, 563, 432], [-610, 414, 1616], [-1744, 1900, 1542], [-1926, 1660, 644], [-518, 1978, 1659], [-512, 1705, 703]]
# scanners.delete_at(4)
#
# # 4
# done << [[1547, -787, 1659], [1967, -735, 392], [2004, 729, 253], [2874, 538, 1841], [2751, 804, 535], [1862, 680, 290], [3174, -445, 1958], [2795, -506, 484], [2806, 768, 501], [2740, 631, 437], [1830, 727, 285], [2434, -108, 1209], [2107, -797, 430], [1688, 808, 1958], [1519, -918, 1524], [2851, -533, 647], [2867, 601, 1947], [1771, 646, 1956], [2968, -433, 1955], [1662, 637, 1871], [1580, -869, 1521], [2902, 667, 1861], [2008, -827, 313], [2785, -481, 570], [3018, -384, 2025], [2494, 3, 1069]]
# scanners.delete_at(4)
#
# # 11
# done << [[1630, 512, -2054], [3101, 751, -678], [3004, 478, -1633], [1798, 466, -2134], [3219, 690, -675], [1867, 405, -811], [1902, -590, -1849], [1914, 510, -748], [3193, -501, -2084], [3182, -449, -2096], [2982, 517, -1831], [3034, -909, -587], [1969, -618, -1964], [3125, -745, -564], [2948, 452, -1788], [1832, -589, -1953], [3004, 719, -622], [2981, -813, -598], [1656, 385, -2073], [2329, -84, -1359], [1780, -538, -886], [2488, -33, -1207], [1940, 285, -756], [1805, -695, -895], [1768, -747, -909], [3142, -501, -2028]]
# scanners.delete_at(11)
#
# # 7
# done << [[2851, -533, 647], [3121, -1612, 809], [2968, -433, 1955], [2993, -1663, 1837], [1580, -869, 1521], [3087, -1661, 777], [3018, -384, 2025], [3164, -1667, 791], [3174, -445, 1958], [2008, -827, 313], [1519, -918, 1524], [2795, -506, 484], [1967, -735, 392], [1547, -787, 1659], [1751, -1625, 659], [2106, -1864, 1542], [2107, -797, 430], [2029, -1904, 1518], [1723, -1696, 672], [2506, -1232, 1223], [2785, -481, 570], [2932, -1649, 2025], [2344, -1248, 1091], [3056, -1575, 1965], [1744, -1647, 699], [2104, -2043, 1570]]
# scanners.delete_at(7)
#
# # 17
# done << [[3931, -409, 1489], [2851, -533, 647], [3018, -384, 2025], [4029, -602, 662], [3087, -1661, 777], [4171, -451, 1494], [2795, -506, 484], [3174, -445, 1958], [4148, -2058, 742], [4089, -2007, 777], [4078, -400, 1444], [4390, -2017, 1481], [3121, -1612, 809], [3683, -1214, 1177], [4089, -2089, 587], [2932, -1649, 2025], [4428, -2019, 1453], [2785, -481, 570], [4070, -450, 618], [2968, -433, 1955], [2993, -1663, 1837], [3056, -1575, 1965], [4446, -2097, 1566], [4009, -508, 730], [3164, -1667, 791]]
# scanners.delete_at(17)
#
# # 5
# done << [[5217, -705, 1808], [4089, -2007, 777], [4009, -508, 730], [5375, -437, 629], [5478, -1651, 1532], [3931, -409, 1489], [5514, -1639, 1505], [4148, -2058, 742], [5270, -373, 606], [4446, -2097, 1566], [5396, -1741, 1533], [4857, -1159, 1079], [4171, -451, 1494], [4078, -400, 1444], [5287, -789, 1872], [4740, -1355, 1229], [4089, -2089, 587], [4390, -2017, 1481], [5187, -2086, 710], [5176, -2153, 568], [5305, -2149, 626], [4428, -2019, 1453], [4070, -450, 618], [4029, -602, 662], [5290, -681, 1968], [5393, -519, 579]]
# scanners.delete_at(5)
#
# # 10
# done << [[4307, -699, 2834], [3174, -445, 1958], [4078, -400, 1444], [4383, -609, 2885], [4446, -2097, 1566], [2815, -2095, 3127], [4428, -2019, 1453], [2968, -433, 1955], [3710, -1300, 2321], [4326, -720, 2758], [3018, -384, 2025], [4104, -1832, 3186], [3029, -679, 3110], [2956, -2106, 3195], [3555, -1169, 2298], [2993, -1663, 1837], [3056, -1575, 1965], [3063, -829, 3223], [4171, -451, 1494], [4390, -2017, 1481], [4070, -1696, 3201], [2939, -831, 3101], [3931, -409, 1489], [2778, -2068, 3200], [2932, -1649, 2025], [4199, -1742, 3143]]
# scanners.delete_at(10)
#
# # 14
# done << [[4428, -2019, 1453], [4446, -2097, 1566], [5302, -1931, 2881], [4070, -1696, 3201], [5217, -705, 1808], [5214, -727, 2818], [5179, -736, 2786], [5478, -1651, 1532], [4307, -699, 2834], [5365, -1924, 2819], [4889, -1325, 2349], [4199, -1742, 3143], [5267, -1910, 2743], [3931, -409, 1489], [5287, -789, 1872], [4171, -451, 1494], [4383, -609, 2885], [4326, -720, 2758], [5514, -1639, 1505], [5244, -818, 2784], [4104, -1832, 3186], [5290, -681, 1968], [4390, -2017, 1481], [4078, -400, 1444], [4715, -1194, 2291], [5396, -1741, 1533]]
# scanners.delete_at(14)
#
# # 2
# done << [[3111, -2900, 2003], [3056, -1575, 1965], [2778, -2068, 3200], [2932, -1649, 2025], [3093, -2925, 1878], [4146, -2896, 1619], [3077, -2937, 2878], [3165, -3023, 2861], [4174, -3015, 1726], [4104, -1832, 3186], [2815, -2095, 3127], [4446, -2097, 1566], [3592, -2403, 2352], [2993, -1663, 1837], [4199, -1742, 3143], [4428, -2019, 1453], [4242, -2850, 3124], [2956, -2106, 3195], [4390, -2017, 1481], [4174, -2914, 3171], [3161, -3050, 1943], [3045, -2990, 2839], [4055, -3031, 1587], [4070, -1696, 3201], [4095, -2908, 3099]]
# scanners.delete_at(2)
#
# # 8
# done << [[4171, -451, 1494], [4326, -720, 2758], [4278, 682, 2753], [3931, -409, 1489], [3063, -829, 3223], [2939, -831, 3101], [4386, 432, 1472], [3151, 260, 2918], [3029, -679, 3110], [2874, 538, 1841], [3625, 11, 2423], [4298, 677, 2704], [3241, 377, 2955], [4348, 505, 1458], [4307, -699, 2834], [2902, 667, 1861], [3668, -106, 2270], [2867, 601, 1947], [4325, 363, 1589], [4383, -609, 2885], [3174, -445, 1958], [3018, -384, 2025], [2968, -433, 1955], [4078, -400, 1444], [4408, 738, 2743], [3274, 323, 3015]]
# scanners.delete_at(8)
#
# # 5
# done << [[5302, -1931, 2881], [4326, -720, 2758], [4199, -1742, 3143], [4152, -1693, 4403], [5663, -1571, 3966], [5692, -1566, 4016], [4901, -1216, 3540], [4104, -1832, 3186], [5267, -1910, 2743], [5365, -1924, 2819], [5244, -818, 2784], [4144, -1663, 4304], [4307, -699, 2834], [4468, -510, 4195], [4383, -609, 2885], [5469, -950, 4046], [4138, -1901, 4347], [4070, -1696, 3201], [5214, -727, 2818], [4242, -563, 4190], [4766, -1325, 3437], [5179, -736, 2786], [5509, -882, 4007], [4306, -523, 4248], [5528, -1666, 3995], [5387, -943, 4118]]
# scanners.delete_at(5)
#
# # 7
# done << [[4390, -2017, 1481], [4104, -1832, 3186], [4446, -2097, 1566], [5514, -1639, 1505], [5583, -3100, 3031], [5676, -3065, 1842], [5522, -3011, 3073], [4174, -2914, 3171], [4428, -2019, 1453], [4146, -2896, 1619], [4070, -1696, 3201], [4055, -3031, 1587], [5672, -3079, 1929], [4242, -2850, 3124], [5267, -1910, 2743], [4199, -1742, 3143], [4906, -2411, 2339], [4095, -2908, 3099], [5655, -3001, 1913], [4174, -3015, 1726], [5396, -1741, 1533], [5478, -1651, 1532], [5501, -2942, 3039], [4762, -2553, 2314], [5365, -1924, 2819], [5302, -1931, 2881]]
# scanners.delete_at(7)
#
# # 7
# done << [[6731, -952, 2763], [5179, -736, 2786], [5973, -1325, 2434], [6632, -1687, 1644], [5287, -789, 1872], [5478, -1651, 1532], [6645, -530, 1717], [5302, -1931, 2881], [5244, -818, 2784], [5214, -727, 2818], [6663, -1965, 2821], [5514, -1639, 1505], [6537, -1959, 2683], [6655, -480, 1761], [5396, -1741, 1533], [6821, -911, 2727], [6427, -1971, 2796], [5365, -1924, 2819], [5267, -1910, 2743], [6106, -1239, 2281], [6550, -1694, 1488], [5290, -681, 1968], [6525, -1735, 1570], [6833, -866, 2870], [5217, -705, 1808], [6572, -459, 1656]]
# scanners.delete_at(7)
#
# # 1
# done << [[1699, -1798, 3034], [3077, -2937, 2878], [1675, -1919, 3159], [2029, -1904, 1518], [3165, -3023, 2861], [1592, -3324, 1597], [3161, -3050, 1943], [2778, -2068, 3200], [2335, -2400, 2263], [2993, -1663, 1837], [2448, -2522, 2421], [3045, -2990, 2839], [3093, -2925, 1878], [2932, -1649, 2025], [1648, -3302, 1519], [1668, -1917, 2893], [1889, -3157, 2776], [2815, -2095, 3127], [3111, -2900, 2003], [2106, -1864, 1542], [1682, -3189, 2819], [2956, -2106, 3195], [1597, -3349, 1574], [2104, -2043, 1570], [3056, -1575, 1965], [1878, -3183, 2735]]
# scanners.delete_at(1)
#
# # 3
# done << [[5663, -1571, 3966], [4138, -1901, 4347], [5583, -3100, 3031], [4152, -1693, 4403], [5267, -1910, 2743], [4095, -2908, 3099], [4164, -3052, 4356], [4189, -3123, 4228], [5438, -3169, 3880], [5302, -1931, 2881], [4242, -2850, 3124], [5528, -1666, 3995], [4070, -1696, 3201], [4104, -1832, 3186], [4144, -1663, 4304], [4909, -2425, 3489], [5365, -1924, 2819], [5501, -2942, 3039], [4199, -1742, 3143], [5419, -3341, 3970], [5522, -3011, 3073], [4174, -2914, 3171], [5692, -1566, 4016], [4760, -2391, 3629], [5454, -3129, 4020], [4113, -3050, 4131]]
# scanners.delete_at(3)
#
# # 3
# done << [[5323, 331, 2006], [5179, -736, 2786], [6433, 512, 3108], [6556, 643, 3135], [6833, -866, 2870], [5290, -681, 1968], [6731, -952, 2763], [5217, -705, 1808], [6821, -911, 2727], [5495, 342, 1933], [6020, 32, 2402], [5287, -789, 1872], [6572, -459, 1656], [6388, 451, 1496], [6645, -530, 1717], [5214, -727, 2818], [6010, -153, 2252], [5693, 737, 3045], [5665, 740, 3207], [5244, -818, 2784], [6394, 395, 1507], [5629, 778, 3119], [6655, -480, 1761], [5431, 408, 2011], [6389, 457, 1490], [6535, 591, 3046]]
# scanners.delete_at(3)
#
# # 1
# done << [[1686, -4261, 3153], [3231, -4324, 1571], [3015, -4051, 2765], [1648, -3302, 1519], [3111, -2900, 2003], [1617, -4329, 3092], [1832, -4277, 1830], [2943, -4190, 2769], [1942, -4195, 1855], [3077, -2937, 2878], [1878, -3183, 2735], [3165, -3023, 2861], [1889, -3157, 2776], [2363, -3742, 2257], [3282, -4182, 1579], [1597, -3349, 1574], [1762, -4253, 3131], [1592, -3324, 1597], [1806, -4231, 1970], [2467, -3569, 2327], [3045, -2990, 2839], [3084, -4243, 2787], [1682, -3189, 2819], [3307, -4227, 1610], [3093, -2925, 1878], [3161, -3050, 1943]]
# scanners.delete_at(1)
#
# # 0
# done << [[5431, 408, 2011], [6394, 395, 1507], [5665, 740, 3207], [6877, 1568, 2765], [6433, 512, 3108], [6389, 457, 1490], [5636, 1603, 2798], [6816, 1719, 1719], [5323, 331, 2006], [6839, 1578, 2779], [5606, 1475, 2783], [5299, 1686, 1851], [6556, 643, 3135], [6095, 1120, 2258], [6881, 1485, 2720], [5629, 778, 3119], [5598, 1503, 2737], [6775, 1827, 1595], [6535, 591, 3046], [6388, 451, 1496], [5693, 737, 3045], [6743, 1819, 1623], [5946, 1113, 2407], [5244, 1607, 1885], [5346, 1685, 1798], [5495, 342, 1933]]
# scanners.delete_at(0)
#
# # 1
# done << [[5242, 602, 4136], [6433, 512, 3108], [5693, 737, 3045], [5232, 641, 4353], [6611, 650, 4178], [6096, -37, 3592], [5244, -818, 2784], [6833, -866, 2870], [6821, -911, 2727], [5509, -882, 4007], [5665, 740, 3207], [5387, -943, 4118], [6702, 745, 4081], [5179, -736, 2786], [5254, 596, 4235], [6637, 778, 4158], [6740, -902, 4308], [6556, 643, 3135], [5629, 778, 3119], [5469, -950, 4046], [6890, -934, 4396], [6535, 591, 3046], [5214, -727, 2818], [5951, -112, 3505], [6731, -952, 2763], [6769, -904, 4400]]
# scanners.delete_at(1)
#
# # 2
# done << [[5393, -519, 579], [5431, 408, 2011], [6434, -912, 780], [6341, 768, 470], [6435, -797, 642], [5227, 442, 421], [5280, 306, 500], [6645, -530, 1717], [6500, 784, 504], [5270, -373, 606], [5318, 287, 379], [5290, -681, 1968], [5323, 331, 2006], [5495, 342, 1933], [6525, -897, 652], [6572, -459, 1656], [6064, -138, 1048], [6394, 395, 1507], [5217, -705, 1808], [6655, -480, 1761], [6389, 457, 1490], [6387, 724, 575], [5951, 39, 1194], [5287, -789, 1872], [5375, -437, 629], [6388, 451, 1496]]
# scanners.delete_at(2)
#
# # 0
# done << [[7642, 587, 2661], [6433, 512, 3108], [6816, 1719, 1719], [6556, 643, 3135], [7914, 1900, 2861], [7915, 1843, 3025], [7997, 1958, 2952], [6839, 1578, 2779], [6394, 395, 1507], [7843, 1546, 1630], [7147, 1080, 2303], [6877, 1568, 2765], [7835, 1609, 1703], [6388, 451, 1496], [7919, 330, 1797], [7729, 325, 1824], [6389, 457, 1490], [6881, 1485, 2720], [7852, 1480, 1596], [6743, 1819, 1623], [7693, 557, 2639], [7829, 342, 1849], [6535, 591, 3046], [7563, 585, 2755], [6775, 1827, 1595], [7305, 1195, 2340]]
# scanners.delete_at(0)
#
# # 0
# done << [[6341, 768, 470], [7953, -472, 1542], [7909, -364, 1645], [6655, -480, 1761], [6388, 451, 1496], [7919, 330, 1797], [6500, 784, 504], [6572, -459, 1656], [7932, -713, 493], [7769, -792, 544], [6389, 457, 1490], [6434, -912, 780], [7240, -75, 1165], [6645, -530, 1717], [6525, -897, 652], [8007, -469, 1597], [7875, -823, 494], [6387, 724, 575], [7629, 306, 562], [6435, -797, 642], [7729, 325, 1824], [7829, 342, 1849], [6394, 395, 1507], [7837, 314, 609], [7631, 300, 588]]
# scanners.delete_at(0)

until scanners.empty?
  dis = (0...done.length).to_a
  sis = (0...scanners.length).to_a

  dis.product(sis).each do |di, si|
    s = scanners[si]
    d = done[di]

    if res = overlap(d, s)
      done << res
      scanners.delete_at(si)
      break
    end
  end
end

puts done.reduce(:|).size
